generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  VENDOR
  INDIVIDUAL
  CUSTOMER
}

enum VerificationType {
  VENDOR
  INDIVIDUAL
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum JobStatus {
  OPEN
  PARTIALLY_ASSIGNED
  FULLY_ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AttendanceEvent {
  CHECK_IN
  CHECK_OUT
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  passwordHash  String
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  roles         UserRole[]
  sessions      SessionToken[]
  vendorProfile VendorProfile?
  individual    IndividualProfile?
  customer      CustomerProfile?
  auditLogs     AuditLog[]
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  role      Role
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
}

model SessionToken {
  id           String   @id @default(cuid())
  userId       String
  refreshHash  String
  expiresAt    DateTime
  revokedAt    DateTime?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VendorProfile {
  id               String                @id @default(cuid())
  userId           String                @unique
  agencyName       String
  website          String?
  ownerAadhar      String
  pan              String
  gst              String?
  pasara           String?
  pf               String?
  esic             String?
  regionCities     String[]
  vendorCode       String?               @unique
  approvalStatus   VerificationStatus    @default(PENDING)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents        Document[]
  verificationReqs VerificationRequest[]
}

model IndividualProfile {
  id               String                @id @default(cuid())
  userId           String                @unique
  agreementDocUrl  String?
  aadhar           String
  pan              String
  regionCity       String
  experienceDocUrl String?
  individualCode   String?               @unique
  approvalStatus   VerificationStatus    @default(PENDING)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents        Document[]
  verificationReqs VerificationRequest[]
  assignments      JobAssignment[]
  attendance       AttendanceLog[]
  presencePings    PresencePing[]
}

model CustomerProfile {
  id         String    @id @default(cuid())
  userId     String    @unique
  company    String?
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs       JobPost[]
}

model VerificationRequest {
  id             String             @id @default(cuid())
  type           VerificationType
  status         VerificationStatus @default(PENDING)
  remarks        String?
  adminUserId    String?
  vendorId       String?
  individualId   String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  vendor         VendorProfile?     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  individual     IndividualProfile? @relation(fields: [individualId], references: [id], onDelete: Cascade)
}

model Document {
  id            String    @id @default(cuid())
  ownerType     String
  ownerId       String
  documentType  String
  storagePath   String
  mimeType      String
  fileSizeBytes Int
  createdAt     DateTime  @default(now())
  vendorId      String?
  individualId  String?
  vendor        VendorProfile?     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  individual    IndividualProfile? @relation(fields: [individualId], references: [id], onDelete: Cascade)

  @@index([ownerType, ownerId])
}

model JobPost {
  id              String         @id @default(cuid())
  customerId      String
  location        String
  guardsRequired  Int
  shift           String
  durationHours   Int
  budget          Decimal        @db.Decimal(12, 2)
  status          JobStatus      @default(OPEN)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  customer        CustomerProfile @relation(fields: [customerId], references: [id], onDelete: Cascade)
  assignments     JobAssignment[]
}

model JobAssignment {
  id            String            @id @default(cuid())
  jobId         String
  individualId  String
  vendorId      String?
  assignedAt    DateTime          @default(now())
  job           JobPost           @relation(fields: [jobId], references: [id], onDelete: Cascade)
  individual    IndividualProfile @relation(fields: [individualId], references: [id], onDelete: Cascade)

  @@unique([jobId, individualId])
}

model AttendanceLog {
  id            String            @id @default(cuid())
  assignmentId  String
  individualId  String
  event         AttendanceEvent
  latitude      Decimal           @db.Decimal(10, 7)
  longitude     Decimal           @db.Decimal(10, 7)
  accuracyM     Decimal?          @db.Decimal(10, 2)
  capturedAt    DateTime          @default(now())
  individual    IndividualProfile @relation(fields: [individualId], references: [id], onDelete: Cascade)

  @@index([assignmentId, capturedAt])
}

model PresencePing {
  id            String            @id @default(cuid())
  assignmentId  String
  individualId  String
  latitude      Decimal           @db.Decimal(10, 7)
  longitude     Decimal           @db.Decimal(10, 7)
  capturedAt    DateTime          @default(now())
  individual    IndividualProfile @relation(fields: [individualId], references: [id], onDelete: Cascade)

  @@index([assignmentId, capturedAt])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String
  action      String
  entityType  String
  entityId    String
  payload     Json?
  createdAt   DateTime @default(now())
  actor       User     @relation(fields: [actorUserId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
}
