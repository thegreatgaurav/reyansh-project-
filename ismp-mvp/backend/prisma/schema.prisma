generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  VENDOR
  INDIVIDUAL
  CUSTOMER
}

enum VerificationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum JobStatus {
  OPEN
  ASSIGNED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum AttendanceType {
  CHECK_IN
  HOURLY_CONFIRMATION
  CHECK_OUT
}

model User {
  id                String          @id @default(cuid())
  email             String          @unique
  passwordHash      String
  role              Role
  isActive          Boolean         @default(true)
  fullName          String?
  phone             String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  vendorProfile     VendorProfile?
  individualProfile IndividualProfile?
  customerProfile   CustomerProfile?
  refreshSessions   RefreshSession[]
  auditLogs         AuditLog[]      @relation("ActorAuditLogs")
}

model RefreshSession {
  id           String   @id @default(cuid())
  userId       String
  tokenHash    String
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  revokedAt    DateTime?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VendorProfile {
  id                 String             @id @default(cuid())
  userId             String             @unique
  agencyName         String
  website            String?
  ownerAadhar        String
  pan                String
  gst                String?
  pasara             String?
  pf                 String?
  esic               String?
  status             VerificationStatus @default(PENDING)
  vendorCode         String?            @unique
  rejectionReason    String?
  approvedAt         DateTime?
  approvedById       String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  approvedBy         User?              @relation(fields: [approvedById], references: [id])
  regions            VendorRegion[]
  documents          VendorDocument[]
  managedIndividuals IndividualProfile[]
  jobAssignments     JobAssignment[]
}

model VendorRegion {
  id        String   @id @default(cuid())
  vendorId  String
  city      String
  state     String?
  createdAt DateTime @default(now())

  vendor VendorProfile @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, city])
}

model VendorDocument {
  id          String   @id @default(cuid())
  vendorId    String
  docType     String
  storageKey  String
  mimeType    String
  sizeBytes   Int
  uploadedAt  DateTime @default(now())

  vendor VendorProfile @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId, docType])
}

model IndividualProfile {
  id                    String             @id @default(cuid())
  userId                String             @unique
  vendorId              String?
  region                String
  agreementDocKey       String
  aadhar                String
  pan                   String
  experienceDocKey      String?
  status                VerificationStatus @default(PENDING)
  individualCode        String?            @unique
  rejectionReason       String?
  approvedAt            DateTime?
  approvedById          String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor                VendorProfile?     @relation(fields: [vendorId], references: [id])
  approvedBy            User?              @relation(fields: [approvedById], references: [id])
  assignments           JobAssignment[]
  attendanceLogs        AttendanceLog[]
}

model CustomerProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  company   String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs Job[]
}

model Job {
  id               String      @id @default(cuid())
  customerId       String
  locationAddress  String
  latitude         Decimal?    @db.Decimal(10, 7)
  longitude        Decimal?    @db.Decimal(10, 7)
  numberOfGuards   Int
  shiftType        String
  durationHours    Int
  budgetAmount     Decimal     @db.Decimal(12, 2)
  status           JobStatus   @default(OPEN)
  startsAt         DateTime?
  endsAt           DateTime?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  customer         CustomerProfile @relation(fields: [customerId], references: [id], onDelete: Cascade)
  assignments      JobAssignment[]
  attendanceLogs   AttendanceLog[]

  @@index([customerId, status])
}

model JobAssignment {
  id             String   @id @default(cuid())
  jobId           String
  vendorId        String
  individualId    String
  assignedById    String
  assignedAt      DateTime @default(now())

  job             Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  vendor          VendorProfile     @relation(fields: [vendorId], references: [id])
  individual      IndividualProfile @relation(fields: [individualId], references: [id])
  assignedBy      User              @relation(fields: [assignedById], references: [id])

  @@unique([jobId, individualId])
}

model AttendanceLog {
  id             String         @id @default(cuid())
  jobId           String
  individualId    String
  attendanceType  AttendanceType
  capturedAt      DateTime       @default(now())
  latitude        Decimal        @db.Decimal(10, 7)
  longitude       Decimal        @db.Decimal(10, 7)
  accuracyMeters  Float?
  deviceId        String?
  note            String?

  job            Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  individual     IndividualProfile @relation(fields: [individualId], references: [id], onDelete: Cascade)

  @@index([jobId, individualId, capturedAt])
}

model AuditLog {
  id            String   @id @default(cuid())
  actorUserId   String
  action        String
  entityType    String
  entityId      String
  metadataJson  Json?
  createdAt     DateTime @default(now())

  actor User @relation("ActorAuditLogs", fields: [actorUserId], references: [id])

  @@index([entityType, entityId])
}
