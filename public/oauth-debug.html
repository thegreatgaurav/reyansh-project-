<!DOCTYPE html>
<html>
<head>
  <title>OAuth Debug - Factory AI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      padding: 12px 20px;
      background-color: #4285F4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background-color: #3367D6;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 100px;
      white-space: pre-wrap;
      background-color: #f9f9f9;
      font-family: monospace;
    }
    .info-box {
      background-color: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
    }
    .error-box {
      background-color: #ffebee;
      border: 1px solid #f44336;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
    }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="container">
    <h1>ðŸ”§ OAuth Debug Page - Factory AI</h1>
    <p>This page helps debug OAuth configuration issues on Vercel.</p>
    
    <div class="info-box">
      <h3>Current Environment Info:</h3>
      <p><strong>URL:</strong> <span id="current-url"></span></p>
      <p><strong>Hostname:</strong> <span id="current-hostname"></span></p>
      <p><strong>Protocol:</strong> <span id="current-protocol"></span></p>
      <p><strong>Expected Redirect URI:</strong> <span id="expected-uri"></span></p>
    </div>
    
    <div>
      <button onclick="testOAuthConfig()">Test OAuth Configuration</button>
      <button onclick="clearResults()">Clear Results</button>
      <button onclick="copyToClipboard()">Copy Results to Clipboard</button>
    </div>
    
    <div id="result">Click "Test OAuth Configuration" to start debugging...</div>
  </div>
  
  <script>
    const CLIENT_ID = '476258971954-k11l81qo4ug6k7ka8vtcm8i0um8htd27.apps.googleusercontent.com';
    const resultDiv = document.getElementById('result');
    
    // Display current environment info
    function updateEnvironmentInfo() {
      document.getElementById('current-url').textContent = window.location.href;
      document.getElementById('current-hostname').textContent = window.location.hostname;
      document.getElementById('current-protocol').textContent = window.location.protocol;
      
      let expectedUri;
      if (window.location.hostname.includes('vercel.app')) {
        expectedUri = 'https://reyanshfactoryai.vercel.app';
      } else if (window.location.hostname === 'localhost') {
        expectedUri = 'http://localhost:3000';
      } else {
        expectedUri = window.location.origin;
      }
      document.getElementById('expected-uri').textContent = expectedUri;
    }
    
    // Test OAuth configuration
    function testOAuthConfig() {
      resultDiv.textContent = 'Testing OAuth configuration...\n\n';
      
      // Check if Google Identity Services is loaded
      if (!window.google) {
        resultDiv.textContent += 'âŒ Google Identity Services not loaded\n';
        resultDiv.textContent += 'Please wait a moment and try again, or check if the script is blocked.\n';
        return;
      }
      
      if (!window.google.accounts) {
        resultDiv.textContent += 'âŒ Google Accounts not available\n';
        return;
      }
      
      resultDiv.textContent += 'âœ… Google Identity Services loaded\n';
      resultDiv.textContent += 'âœ… Google Accounts available\n\n';
      
      // Test OAuth client initialization
      try {
        const redirectUri = window.location.hostname.includes('vercel.app') 
          ? 'https://factoryai-olive.vercel.app' 
          : 'http://localhost:3000';
        
        resultDiv.textContent += `ðŸ”§ Testing with redirect URI: ${redirectUri}\n`;
        resultDiv.textContent += `ðŸ”§ Current location: ${window.location.href}\n`;
        resultDiv.textContent += `ðŸ”§ Client ID: ${CLIENT_ID}\n\n`;
        
        // Initialize OAuth client
        window.google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: 'openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile',
          redirect_uri: redirectUri,
          callback: function(response) {
            if (response && response.access_token) {
              resultDiv.textContent += 'ðŸŽ‰ SUCCESS! OAuth token received!\n';
              resultDiv.textContent += 'Your OAuth configuration is working correctly.\n';
              resultDiv.textContent += `Token length: ${response.access_token.length} characters\n`;
            } else {
              resultDiv.textContent += 'âŒ No access token received\n';
              resultDiv.textContent += 'Response: ' + JSON.stringify(response, null, 2) + '\n';
            }
          }
        });
        
        resultDiv.textContent += 'âœ… OAuth client initialized successfully\n';
        resultDiv.textContent += 'Click the Google Sign-In button below to test the full flow.\n\n';
        
        // Add Google Sign-In button
        if (!document.getElementById('google-signin')) {
          const signinDiv = document.createElement('div');
          signinDiv.id = 'google-signin';
          signinDiv.style.marginTop = '20px';
          document.querySelector('.container').appendChild(signinDiv);
          
          window.google.accounts.id.renderButton(signinDiv, {
            theme: 'outline',
            size: 'large',
            width: 300,
            text: 'signin_with'
          });
        }
        
      } catch (error) {
        resultDiv.textContent += `âŒ Error initializing OAuth client: ${error.message}\n`;
        resultDiv.textContent += `Stack: ${error.stack}\n`;
      }
    }
    
    function clearResults() {
      resultDiv.textContent = 'Results cleared. Click "Test OAuth Configuration" to start debugging...';
    }
    
    function copyToClipboard() {
      navigator.clipboard.writeText(resultDiv.textContent).then(function() {
        alert('Results copied to clipboard!');
      }).catch(function(err) {
        console.error('Could not copy text: ', err);
        alert('Failed to copy results. Please copy manually.');
      });
    }
    
    // Initialize page
    window.onload = function() {
      updateEnvironmentInfo();
      
      // Auto-test after a short delay
      setTimeout(() => {
        if (window.google) {
          testOAuthConfig();
        }
      }, 1000);
    };
  </script>
</body>
</html>
